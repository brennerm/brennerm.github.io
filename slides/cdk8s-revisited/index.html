<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>cdk8s, the future of Kubernetes application deployments? - revisited</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <link rel="stylesheet" href="dist/theme/black.css" id="theme">


  <style>
    .reveal .footer {
      position: absolute;
      bottom: 1em;
      right: 1em;
      font-size: 0.5em;
    }
  </style>

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/solarized-dark.min.css" id="highlight-theme">
</head>

<body>
  <div class="reveal">
    <div class="footer">
      <img style="height: 50px" src="https://cdk8s.io/docs/v1.0.0-beta.11/assets/logos/horizontal/cdk8s.horizontal.white.svg"></img>
    </div>
    <div class="slides">
      <section>
        <img style="height: 400px" src="https://cdk8s.io/docs/v1.0.0-beta.11/assets/logos/stacked/cdk8s.stacked.white.svg"></img>
        <h2>the future of Kubernetes application deployments? - revisited</h2>
      </section>
      <section>
        <h1>Agenda</h1>
        <ul>
          <li>Who's talking?</li>
          <li>What's cdk8s?</li>
          <li>What's new?</li>
          <li>What's to come?</li>
        </ul>
      </section>
      <section>
        <h2>Who's talking?</h2>
        <ul>
          <li class="fragment">Max aka brennerm</li>
          <li class="fragment">Freelance DevOps Engineer</li>
          <li class="fragment">Kubernetes, Cloud Infrastructure</li>
          <li class="fragment">coding @ github.com/brennerm</li>
          <li class="fragment">writing @ shipit.dev</li>
          <li class="fragment">other interests: motorcycles, bikes, sports</li>
        </ul>
      </section>
      <section>
        <section>
          <h1>What's cdk8s?</h1>
        </section>
        <section>
          <blockquote>CDK8s is a software development framework for defining Kubernetes applications and reusable abstractions using familiar programming languages and rich object-oriented APIs.</blockquote>
        </section>
        <section>
          <h3>Kubernetes manifest evolution</h3>
          <span class="fragment">plain YAML</span>
          <span class="fragment">&rarr; kustomize</span>
          <span class="fragment">&rarr; Helm</span>
          <span class="fragment">&rarr; cdk8s</span>
        </section>
        <section>
          <pre><code data-trim class="yaml" data-line-numbers="1-2|3-4|6|7-13|16-17">
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: my-deployment
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: my-app
              template:
                metadata:
                  labels:
                    app: my-app
                spec:
                  containers:
                    - image: my-app:1.0
                      name: my-app
          </code></pre>
        </section>
        <section>
          <pre><code data-trim class="python" data-line-numbers="1|5|7|8|10|11-13|15-18|24-26">
            class MyChart(Chart):
              def __init__(self, scope: Construct, id: str):
                  super().__init__(scope, id)

                  label = {"app": "my-app"}

                  k8s.KubeDeployment(self,
                    'my-deployment',
                    spec=k8s.DeploymentSpec(
                      replicas=2,
                      selector=k8s.LabelSelector(match_labels=label),
                      template=k8s.PodTemplateSpec(
                        metadata=k8s.ObjectMeta(labels=label),
                        spec=k8s.PodSpec(containers=[
                          k8s.Container(
                            name='my-app',
                            image='my-app:1.0'
                          )
                        ])
                      )
                    )
                  )

            app = App()
            MyChart(app, "my-app")
            app.synth()
          </code></pre>
        </section>
        <section>
          <h2>App</h2>
          <ul>
            <li>container for charts</li>
            <li>entry point for the synthesizing process</li>
          </ul>
        </section>
        <section>
          <h2>Chart</h2>
          <ul>
            <li>container for constructs</li>
            <li>results in a single Kubernetes manifest</li>
            <li>can declare namespace and labels for all resources</li>
          </ul>
        </section>
        <section>
          <h2>Construct</h2>
          <ul>
            <li class="fragment">L1 &rarr; autogenerated Kubernetes objects</li>
            <li class="fragment">L2 &rarr; abstractions on top of L1s</li>
          </ul>
          <pre class="fragment"><code data-trim class="ts" data-line-numbers="1|2-4|7-10|12-14|16-18">
            export class WebService extends Construct {
              constructor(scope: Construct,
                          id: string,
                          options: WebServiceOptions) {
                super(scope, id);
              
                const port = options.port || 80;
                const containerPort = options.containerPort || 8080;
                const label = { app: Names.toLabelValue(this) };
                const replicas = options.replicas ?? 1;
              
                new KubeService(this, 'service', {
                  ...
                });
              
                new KubeDeployment(this, 'deployment', {
                  ...
                });
              }
            }
          </code></pre>
        </section>

        <section>
          <h2>CLI</h2>
          <ul>
            <li class="fragment">installation: <em>npm install -g cdk8s-cli</em></li>
            <li class="fragment">init - starts a new project</li>
            <li class="fragment">import - provides classes for K8s or CRD objects</li>
            <li class="fragment">synth - generates K8s manifest from cdk8s code</li>
          </ul>
        </section>

        <section>
          <h2>workflow</h2>
          <pre><code data-trim class="shell" data-line-numbers="1|2-15|16-17|18|19-20|21|22">
            $ cdk8s init python-app
            Initializing a project from the python-app template
            ...
            =========================================================

             Your cdk8s Python project is ready!

               cat help      Prints this message  
               cdk8s synth   Synthesize k8s manifests to dist/
               cdk8s import  Imports k8s API objects to "imports/k8s"

              Deploy:
               kubectl apply -f dist/*.k8s.yaml

            =========================================================
            $ ls
            cdk8s.yaml  dist  help  imports  main.py  Pipfile  Pipfile.lock
            $ vi main.py
            $ cdk8s synth
            dist/my-app.k8s.yaml
            $ kubectl apply -f dist/my-app.k8s.yaml
            $ cdk8s synth -p | kubectl apply -f -
          </code></pre>
        </section>
      </section>
      <section>
        <section>
          <h1>What's new?</h2>
        </section>
        <section>
          <h2>Helm support</h2>
          <ul class="fragment">
            <li>contribution by Matthew Bonig</li>
          </ul>
          <pre class="fragment"><code data-trim class="ts" data-line-numbers="1|5-12|16-21">
              class MyChart extends cdk8s.Chart {
                constructor(scope: Construct, id: string) {
                  super(scope, id);
                
                  const redis = new Helm(this, 'redis', {
                    chart: 'bitnami/redis',
                    values: {
                      sentinel: {
                        enabled: true
                      }
                    }
                  });
                }
              }
              
              const master = redis.apiObjects
                .find(o => o.name === 'my-redis-master');
              
              master.metadata.addAnnotation(
                'my.annotation', 'hey-there'
              );
      		  </code></pre>
          <ul class="fragment">
            <li>use Include construct for plain YAML manifests</li>
          </ul>
        </section>
        <section>
          <h2>cdk8s+</h2>
          <ul>
            <li>library built on top of cdk8s</li>
            <li>includes high level objects and functions</li>
            <li>aims to simplify day-to-day use cases</li>
            <li>will align with Kubernetes version</li>
          </ul>
        </section>

        <section>
          <pre><code data-trim class="ts" data-line-numbers="1|3-5|7-18|20|21-23">
          const chart = new cdk8s.Chart(app, 'my-chart');

          const appData = new kplus.ConfigMap(chart, 'AppData');
          appData.addDirectory(path.join(__dirname, 'app'));
          const appVolume = kplus.Volume.fromConfigMap(appData);

          const deployment = new kplus.Deployment(chart,
            'Deployment',
            { replicas: 3 }
          );
          const appPath = '/var/lib/app';
          const port = 80;
          const container = deployment.addContainer({
            image: 'node:14.4.0-alpine3.12',
            command: ['node', 'index.js', `${port}`],
            port: port,
            workingDir: appPath,
          });

          container.mount(appPath, appVolume);
          deployment.expose(8080,
            {serviceType: kplus.ServiceType.LOAD_BALANCER}
          )
          </code></pre>
        </section>
        <section>
          <h2>Java support</h2>
          <pre class="fragment"><code data-trim class="java" data-line-numbers="1,2|4-10|12-16|18-21|23">
          final Map&lt;String, String&gt; selector = new HashMap&lt;&gt;();
          selector.put("app", "hello-k8s");

          final List&lt;ServicePort&gt; servicePorts = new ArrayList&lt;&gt;();

          final ServicePort servicePort = new ServicePort.Builder()
            .port(80)
            .targetPort(IntOrString.fromNumber(8080))
            .build();
          servicePorts.add(servicePort);

          final ServiceSpec serviceSpec = new ServiceSpec.Builder()
            .type("LoadBalancer")
            .selector(selector)
            .ports(servicePorts)
            .build();

          final KubeServiceProps serviceProps =
            new KubeServiceProps.Builder()
            .spec(serviceSpec)
            .build();

          new KubeService(this, "service", serviceProps);
          </code></pre>
        </section>
      </section>
      <section>
        <section>
          <h1>What's to come?</h1>
        </section>
        <section>
          <h2>Go bindings</h2>
          <pre><code data-trim class="shell">
            $ cdk8s init golang-app
          </code></pre>
        </section>
        <section>
          <h2>working towards 1.0</h2>
          <ul>
            <li>main goal: stability</li>
            <li>cdk8s+ API will be finished</li>
          </ul>
        </section>
        <section>
          <h2>ideas</h2>
          <ul>
            <li class="fragment">Helm chart generation</li>
            <li class="fragment">publish constructs as CRDs</li>
            <li class="fragment">bundle Docker images</li>
          </ul>
          <p class="fragment">Give your vote!</p>
        </section>
      </section>
      <section>
        <h2>Thanks for joining!</h2>
        <p>
          open questions?
          <br> &#8595;
        </p>
        <ul>
          <li>twitter: @__brennerm</li>
          <li>email: max@shipit.dev</li>
        </ul>
        <h2 class="fragment">Huge thanks for the orga!</h2>
        <h2 class="fragment">Enjoy the rest of the talks!</h2>
      </section>
    </div>
  </div>

  <script src="dist/reveal.js"></script>
  <script src="plugin/notes/notes.js"></script>
  <script src="plugin/markdown/markdown.js"></script>
  <script src="plugin/highlight/highlight.js"></script>
  <script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
      hash: true,
      controls: false,
      slideNumber: 'c/t',

      // Learn about plugins: https://revealjs.com/plugins/
      plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
  </script>
</body>

</html>